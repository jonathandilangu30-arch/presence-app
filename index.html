UZIEL&BROTHERS CORPORATE Sarl
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Scan QR ‚Äì Pr√©sence Ultra-Robuste</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="html5-qrcode.min.js"></script> <!-- Version locale -->

<!-- Lien vers le manifest -->
<link rel="manifest" href="manifest.json">

<!-- Balises iOS pour PWA -->
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="UBC Scan">

<style>
body { 
    font-family: Arial; 
    text-align:center; 
    padding:20px; 
    background-image: url('background.jpg'); /* ton image de fond */
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    color: white;
}

#reader { 
    width:320px; 
    margin:auto; 
    margin-top:20px; 
    border-radius: 12px;
    overflow: hidden;
    background: rgba(0,0,0,0.2);
}

#result { 
    margin-top:25px; 
    font-size:20px; 
    font-weight:bold; 
}

.success{color:lightgreen;} 
.error{color:red;}

button,input[type="file"] { 
    margin-top:15px; 
    padding:10px; 
    font-size:16px; 
    border-radius:8px;
    border:none;
    cursor:pointer;
}
</style>
</head>
<body>
<h1>Scanner le QR Code</h1>

<div id="reader"></div>
<input type="file" id="fileInput" accept="image/*">
<div id="result"></div>

<script>
// ------------------------------
// üîê CONFIG SUPABASE
// ------------------------------
const SUPABASE_URL = "https://smosrvzannsxvoywopwg.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtb3Nydnphbm5zeHZveXdvcHdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTIyMTQsImV4cCI6MjA3OTU4ODIxNH0.Qx9VAd_9FdIPINCgh0J_XDS0TC3O290Mot9BZCJT3S8";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let html5QrCode;

// ------------------------------
// üîπ FONCTION ULTRA-ROBUSTE DE NETTOYAGE QR
// ------------------------------
function cleanQrCode(rawQr){
    if(!rawQr) return null;
    let code = rawQr.replace(/[\u200B-\u200D\uFEFF\s\n\r\t]+/g, '');
    code = code.toUpperCase();
    const match = code.match(/QR[0-9A-Z]+/i);
    return match ? match[0] : null;
}

// ------------------------------
// üìå ENREGISTRER LA PR√âSENCE
// ------------------------------
async function registerPresence(qrCode){
    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML="‚è≥ V√©rification...";

    const cleanedCode = cleanQrCode(qrCode);
    if(!cleanedCode){
        resultDiv.innerHTML="<span class='error'>‚ùå QR Code invalide</span>";
        return;
    }

    const {data: employee, error: empErr} = await supabaseClient
        .from("employees")
        .select("id,name")
        .eq("qr_code", cleanedCode)
        .single();

    if(empErr || !employee){
        resultDiv.innerHTML="<span class='error'>‚ùå QR Code invalide</span>";
        return;
    }

    const today = new Date().toISOString().split("T")[0];
    const {data: existingToday} = await supabaseClient
        .from("daily_presence")
        .select("id")
        .eq("employee_id", employee.id)
        .eq("presence_date", today);

    if(existingToday && existingToday.length > 0){
        resultDiv.innerHTML=`<span class='error'>‚ùå Pr√©sence d√©j√† enregistr√©e aujourd'hui pour ${employee.name}</span>`;
        return;
    }

    const now = new Date();
    const timeString = now.toTimeString().split(' ')[0];

    const { error: presErr } = await supabaseClient
        .from("daily_presence")
        .insert([{
            employee_id: employee.id,
            presence_date: today,
            presence_time: timeString
        }]);

    if(presErr){
        resultDiv.innerHTML="<span class='error'>‚ùå "+presErr.message+"</span>";
        return;
    }

    resultDiv.innerHTML=`<span class='success'>‚úî Pr√©sence enregistr√©e pour ${employee.name} √† ${timeString}</span>`;
}

// ------------------------------
// üé• SCANNER CAM√âRA (cam√©ra avant par d√©faut)
// ------------------------------
function startCameraScanner() {
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
        {facingMode:"user"},
        {fps:10, qrbox:250},
        qrCodeMessage => {
            html5QrCode.stop();
            registerPresence(qrCodeMessage).then(() => {
                startCameraScanner();
            });
        },
        errorMessage => {}
    ).catch(err=>{
        document.getElementById("result").innerHTML="<span class='error'>‚ùå Impossible d‚Äôacc√©der √† la cam√©ra</span>";
        console.error(err);
    });
}

// ------------------------------
// üìÅ SCANNER UN FICHIER IMAGE
// ------------------------------
const fileInput = document.getElementById("fileInput");
fileInput.addEventListener("change", async () => {
    const file = fileInput.files[0];
    if(!file) return;

    try{
        if(html5QrCode && html5QrCode.getState() === Html5QrcodeScannerState.SCANNING){
            await html5QrCode.stop();
        }

        const qrCodeMessage = await html5QrCode.scanFile(file, true);
        await registerPresence(qrCodeMessage);

        startCameraScanner();
    } catch(err){
        document.getElementById("result").innerHTML="<span class='error'>‚ùå QR Code invalide</span>";
        console.error(err);
    }
});

// ------------------------------
// üîπ D√âMARRAGE DU SCANNER
// ------------------------------
startCameraScanner();

// ------------------------------
// üîπ ENREGISTRER SERVICE WORKER PWA
// ------------------------------
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('Service Worker enregistr√©', reg))
      .catch(err => console.error('Erreur SW:', err));
  });
}
</script>
</body>
</html>
