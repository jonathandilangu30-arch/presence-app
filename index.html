<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Scan QR ‚Äì Pr√©sence Ultra-Robuste</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="html5-qrcode.min.js"></script>

<style>
body {
    font-family: Arial; 
    text-align:center; 
    padding:20px; 
    background: url('background.jpg') no-repeat center center fixed; 
    background-size: cover;
}

/* Bo√Æte du scanner */
#reader {
    width:320px; 
    margin:auto; 
    margin-top:20px; 
    border-radius:20px; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.35);
    overflow:hidden;
    backdrop-filter: blur(4px);
}

/* Boutons */
button {
    margin-top:15px;
    padding:12px 18px;
    font-size:17px;
    border-radius:50px;
    border:none;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    width:260px;
    margin-left:auto;
    margin-right:auto;
    color:white;
    background:#0051ff;
    transition:0.25s;
}

button:hover {
    background:#003ad6;
    transform:scale(1.04);
}

.btn-secondary {
    background:#444;
}
.btn-secondary:hover {
    background:#222;
}

.icon {
    font-size:21px;
}

/* Flash succ√®s */
#flash {
    width:60px; 
    height:60px; 
    background:limegreen; 
    border-radius:50%; 
    margin:auto; 
    display:none; 
    animation: flashAnim 0.5s ease;
}

@keyframes flashAnim {
    0% { transform: scale(0.5); opacity:0; }
    50% { transform: scale(1.3); opacity:1; }
    100% { transform: scale(1); opacity:0; }
}

#result { 
    margin-top:25px; 
    font-size:20px; 
    font-weight:bold; 
    color:white;
    text-shadow:2px 2px 4px black;
}

input[type="file"] {
    margin-top:15px; 
    padding:12px; 
    font-size:16px; 
    color:white;
    background:#222; 
    border-radius:10px;
}
</style>
</head>

<body>

<h1>üì∑ Scanner le QR Code</h1>

<button id="switchCameraBtn">
    <span class="icon">üîÑ</span> Changer cam√©ra
</button>

<div id="reader"></div>

<div id="flash"></div>

<input type="file" id="fileInput" accept="image/*">

<button id="toggleFlashBtn" class="btn-secondary">
    <span class="icon">üî¶</span> Lampe torche
</button>

<div id="result"></div>

<script>
const SUPABASE_URL = "https://smosrvzannsxvoywopwg.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtb3Nydnphbm5zeHZveXdvcHdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTIyMTQsImV4cCI6MjA3OTU4ODIxNH0.Qx9VAd_9FdIPINCgh0J_XDS0TC3O290Mot9BZCJT3S8";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let html5QrCode;
let torchOn = false;
let useFrontCamera = false;

/* Nettoyage QR */
function cleanQrCode(rawQr){
    if(!rawQr) return null;
    let code = rawQr.replace(/[\u200B-\u200D\uFEFF\s\n\r\t]+/g,'').toUpperCase();
    const match = code.match(/QR[0-9A-Z]+/i);
    return match ? match[0] : null;
}

/* Enregistrement pr√©sence */
async function registerPresence(qrCode){
    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML="‚è≥ V√©rification...";

    const cleanedCode = cleanQrCode(qrCode);
    if(!cleanedCode){
        resultDiv.innerHTML="<span class='error'>‚ùå QR Code invalide</span>";
        return;
    }

    const {data: employee, error: empErr} = await supabaseClient
        .from("employees")
        .select("id,name")
        .eq("qr_code", cleanedCode)
        .single();

    if(empErr || !employee){
        resultDiv.innerHTML="<span class='error'>‚ùå QR Code invalide</span>";
        return;
    }

    const today = new Date().toISOString().split("T")[0];
    const {data: existingToday} = await supabaseClient
        .from("daily_presence")
        .select("id")
        .eq("employee_id", employee.id)
        .eq("presence_date", today);

    if(existingToday && existingToday.length>0){
        resultDiv.innerHTML=`<span class='error'>‚ùå Pr√©sence d√©j√† enregistr√©e aujourd'hui pour ${employee.name}</span>`;
        return;
    }

    const now = new Date();
    const timeString = now.toTimeString().split(' ')[0];

    const { error: presErr } = await supabaseClient
        .from("daily_presence")
        .insert([{
            employee_id: employee.id,
            presence_date: today,
            presence_time: timeString
        }]);

    if(presErr){
        resultDiv.innerHTML="<span class='error'>‚ùå "+presErr.message+"</span>";
        return;
    }

    // Flash succ√®s
    const flash = document.getElementById("flash");
    flash.style.display = "block";
    setTimeout(()=>{ flash.style.display="none"; }, 500);

    resultDiv.innerHTML=`<span class='success'>‚úî Pr√©sence enregistr√©e pour ${employee.name} √† ${timeString}</span>`;
}

/* Scanner cam√©ra */
function startCameraScanner() {
    if(html5QrCode){
        html5QrCode.stop();
    }

    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
        {facingMode: useFrontCamera ? "user" : "environment"},
        {fps:10, qrbox:250},
        qrCodeMessage => {
            html5QrCode.stop().then(() => {
                registerPresence(qrCodeMessage).then(()=>{
                    setTimeout(()=>startCameraScanner(),1000);
                });
            });
        }
    ).catch(err=>{
        document.getElementById("result").innerHTML="<span class='error'>‚ùå Impossible d‚Äôacc√©der √† la cam√©ra</span>";
        console.error(err);
    });
}

/* Bouton changer cam√©ra */
document.getElementById("switchCameraBtn").addEventListener("click", ()=>{
    useFrontCamera = !useFrontCamera;
    startCameraScanner();
});

/* Scanner fichier */
const fileInput = document.getElementById("fileInput");
fileInput.addEventListener("change", async ()=>{
    const file = fileInput.files[0];
    if(!file) return;

    try{
        if(html5QrCode){
            await html5QrCode.stop();
        }

        const qrCodeMessage = await html5QrCode.scanFile(file, true);
        await registerPresence(qrCodeMessage);

        setTimeout(()=>startCameraScanner(),1000);
    } catch(err){
        document.getElementById("result").innerHTML="<span class='error'>‚ùå QR Code invalide</span>";
        console.error(err);
    }
});

/* Lampe torche */
document.getElementById("toggleFlashBtn").addEventListener("click", async ()=>{
    if(!html5QrCode) return;
    try{
        torchOn = !torchOn;
        await html5QrCode.applyVideoConstraints({advanced:[{torch: torchOn}]});
    } catch(err){
        alert("Lampe non disponible sur cet appareil");
    }
});

/* D√©marrage par cam√©ra arri√®re */
startCameraScanner();
</script>

</body>
</html>
 
